<template>
  <v-card class="pa-4 mt-4">
    <template #title>
      <div class="text-h6 text-center w-100">ðŸšª HÃ¼hnerklappe</div>
    </template>
    <v-row align="center" justify="center">
      <v-col>
        <v-btn color="blue" @click="moveDoor('up')" :disabled="open" class="fade-button">
          <v-icon :icon="mdiArrowUpBold" />
        </v-btn>
      </v-col>
      <v-col>
        <div class="text-body-1 font-weight-medium" data-testid="door-status-text">{{ doorStatusText }}</div>
      </v-col>
      <v-col>
        <v-btn color="blue" @click="moveDoor('down')" :disabled="closed" class="fade-button">
          <v-icon :icon="mdiArrowDownBold" />
        </v-btn>
      </v-col>
    </v-row>
  </v-card>
</template>

<script setup lang="ts">
import { authenticatedFetch } from '@/auth'
import { useAuth } from '@/composables/useAuth'
import { mdiArrowUpBold, mdiArrowDownBold } from '@mdi/js'
import { ref, computed, onMounted } from 'vue'

const { currentUser } = useAuth()

const doorStatus = ref<number>(0)

const DoorStateLabels = ['Unbekannt', 'Offen', 'Geschlossen', 'Ã–ffnet...', 'SchlieÃŸt...']

const doorStatusText = computed(() => DoorStateLabels[doorStatus.value] ?? 'Fehler')
const closed = computed(() => doorStatus.value == 2)
const open = computed(() => doorStatus.value == 1)

async function fetchDoorState() {
  try {
    if (!currentUser.value) {
      doorStatus.value = 0
      return
    }
    const token = await currentUser.value.getIdToken()
    const data = await authenticatedFetch<{ status: number }>('/door-state', token)
    doorStatus.value = data.status
  } catch (err) {
    console.error('Fehler beim Abrufen des TÃ¼rstatus:', err)
    doorStatus.value = 0 // fallback to UNDEFINED
  }
}

setInterval(fetchDoorState, 2000)

onMounted(() => {
  fetchDoorState()
})

async function moveDoor(direction: 'up' | 'down') {
  try {
    if (!currentUser.value) {
      console.error('Cannot move door, user not logged in.')
      return
    }
    const token = await currentUser.value.getIdToken()
    await authenticatedFetch(`/door?direction=${direction}`, token, { method: 'POST' })
    await fetchDoorState()
  } catch (err) {
    console.error(`Error moving door ${direction}:`, err)
  }
}
</script>
<style scoped>
.fade-button {
  transition: opacity 0.3s ease;
}
.fade-button:disabled {
  opacity: 0.3;
  filter: grayscale(100%);
}
</style>
